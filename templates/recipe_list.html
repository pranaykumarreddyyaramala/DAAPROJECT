{% extends "layout.html" %}
{% block content %}
<style>
  body { background: linear-gradient(135deg, #ffecd2, #fcb69f); min-height:100vh; }
  .card { border-radius:14px; overflow:hidden; transition:transform .25s, box-shadow .25s; }
  .card:hover { transform: translateY(-6px); box-shadow: 0 14px 30px rgba(0,0,0,.18); }
  .recipe-img { height:190px; object-fit:cover; width:100%; display:block; }
  .card-img-overlay { background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); color:white; padding:10px; }
  .btn-dark { width:100%; border-radius:26px; font-weight:700; }
  .insights { background: rgba(255,255,255,0.9); padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  .stat { font-weight:700; }
</style>

<div class="container my-5">
  <div class="mb-4 d-flex justify-content-between align-items-center">
    <h2 class="mb-0">üçΩ Matching Recipes</h2>
    <div>
      <a href="{{ url_for('index') }}" class="btn btn-outline-dark">‚Üê New Search</a>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left: results grid -->
    <div class="col-lg-8">
      <div class="row">
        {% if recipes %}
          {% for item in recipes %}
            {% set r = item.recipe %}
            <div class="col-md-6 mb-4">
              <div class="card shadow-sm h-100">
                <div class="position-relative">
                  <img src="{{ url_for('static', filename=r.image) }}" class="recipe-img" alt="{{ r.name }}">
                  <div class="card-img-overlay d-flex align-items-end justify-content-center">
                    <h5 class="fw-bold text-center">{{ r.name }}</h5>
                  </div>
                </div>
                <div class="card-body">
                  <p class="mb-1"><span class="badge bg-info text-dark">Score: {{ item.score }}</span>
                  <span class="badge bg-secondary ms-2">{{ r.ingredients|length }} ing</span></p>

                  <p class="mb-1">Missing: 
                    {% if item.missing %}
                      <span class="text-danger">{{ item.missing|join(', ') }}</span>
                    {% else %}
                      <span class="text-success">None ‚Äî you have everything!</span>
                    {% endif %}
                  </p>

                  <!-- Substitutions preview -->
                  {% if item.substitutions %}
                    <p class="mb-2">
                      Suggestions:
                      {% for key, subs in item.substitutions.items() %}
                        <span class="badge bg-warning text-dark">{{ key }}</span>
                      {% endfor %}
                    </p>
                  {% endif %}

                  <a href="{{ url_for('recipe_detail', recipe_id=r.id) }}" class="btn btn-dark mt-2">View Recipe ‚û°Ô∏è</a>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="col-12">
            <div class="insights">
              <h5>No matching recipes found</h5>
              <p>Try adding more ingredients or check spelling. FlavorGraph will try to suggest substitutions where possible.</p>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Right: insights -->
    <div class="col-lg-4">
      <div class="insights mb-4">
        <h5>üîé Search Summary</h5>
        <p class="mb-1"><span class="stat">Available Ingredients:</span> <br> <small>{{ available_raw }}</small></p>
        <hr>
        <h6>Graph Stats</h6>
        <p class="mb-1">Ingredient nodes: {{ graph.ingredient_to_recipes|length }}</p>
        <p class="mb-1">Connected recipes: {{ graph.recipe_to_ingredients|length }}</p>
      </div>

      <div class="insights mb-4">
        <h5>‚ö° Greedy Picks (max {{ num_combo }})</h5>
        {% if greedy_choices %}
          <ol>
          {% for ch in greedy_choices %}
            <li><strong>{{ ch.recipe.name }}</strong> ‚Äî covers {{ ch.covered|length }} ing ({{ ch.covered|join(', ') }})</li>
          {% endfor %}
          </ol>
          <p class="mt-2">Total covered ingredients: <strong>{{ greedy_covered|length }}</strong> ‚Äî <small>{{ greedy_covered|join(', ') }}</small></p>
        {% else %}
          <p>No greedy picks found with current ingredients.</p>
        {% endif %}
      </div>

      <div class="insights mb-4">
        <h5>üîÅ Best Combo (Backtracking)</h5>
        {% if bt_best.recipes %}
          <p>Coverage: <strong>{{ bt_best.coverage_count }}</strong> ingredient(s)</p>
          <ul>
          {% for r in bt_best.recipes %}
            <li>{{ r.name }} ({{ r.ingredients|length }} ing)</li>
          {% endfor %}
          </ul>
          <p class="small text-muted">Score sum: {{ "%.2f"|format(bt_best.score_sum) }}</p>
        {% else %}
          <p>No strong combo found. Try adding more ingredients.</p>
        {% endif %}
      </div>

      <div class="insights">
        <h5>üîß Tips</h5>
        <ul class="small">
          <li>Try including seasonings like salt, oil, butter to increase matches.</li>
          <li>Use the substitution suggestions from the recipe detail page.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}
